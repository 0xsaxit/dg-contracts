# Master/Child game design implementation

## Phase 1 - setting-up contracts
- A1) Decide your *default token* (address, name) as input parameters and deploy `MasterParent.sol` (contracts/master-example/MasterParent.sol)

	input -> constructor (`address defaultToken, string  tokenName`)
	output -> master address (`0x34ae0be093a2c82c63aaf763abb94b8343b56241`)

- B1) Deploy game (contracts/master-example/Roulette.sol)

	input parameters: `address _masterAddress` and `uint256 _maxSquareBet`
	output -> game address (`0xde39dd59f3e3525bace5e7718a70d5646d20f14e`)
		_masterAddress - check step A) when deploying MasterParent.sol
		_maxSquareBet - maximum amount of bet on each sqaure in game (in wei)

- B2) Deploy game (contracts/master-example/Slots.sol)
	input parameters: `address _masterAddress`
	output -> game address (`0x641AD78BAca220C5BD28b51Ce8e0F495e85Fe689`)
		_masterAddress - check step A) when deploying MasterParent.sol

- C1) Add games to master by using `masterParent.addGame(_gameAddress, _newGameName, _isActive (true || false))` (game address take from B1/B2)
		_gameAddress - check output of step B1 and B2 when deploying games

## Phase 2 - allocating funds for each game

- Before allocating funds(tokens) for each game make sure you've added any other additional tokens to the master contract:
  using: `masterContract.addToken()` with 2 parameters: \_tokenAddress, \_tokenName

- Now that you've added tokens you can allocate any of those for each game by using the `masterContract.addFunds()` function with the following parameters: \_gameID, \_tokenAmount, \_tokenName (\_gameID is the index of the game in array (0, 1, 2, etc...))

  _Important: Before executing this function make sure this contract is approved to access your wallet funds_

- You can also allocate funds manually. Simply send tokens to the masterContract address and use the `masterContract.manaulAllocation()` function

- To withdraw funds from the contract use the `masterContract.withdrawCollateral()` function with the \_gameID, \_amount, and \_tokensName parameters. For example: `masterContract.withdrawCollateral(0, 100000000000000, "MANA")`

  _(or simply call withdrawMaxTokenBalance() using the \_tokenName to withdraw all of the contract funds)_

## Phase 3 - play games

```javascript
    masterContract.play(_gameID, _userAddress, _landID, _machineID, _betIDs[], _betValues[], _betAmount[], _localhash, _tokenName);
    masterContract.play(0, address, uint256, uint256, uint256[], uint256[], uint256[], bytes32, string); // playing roulette
    masterContract.play(0, 0x641ad78baca220c5bd28b51ce8e0f495e85fe689, 1, 1, [3302], [0], [1000000000000000], localhash, "MANA"); // betting on Even
    masterContract.play(0, 0x641ad78baca220c5bd28b51ce8e0f495e85fe689, 1, 1, [3302, 3306], [0,0], [1000000000000000, 1000000000000000], [1,1], _localhash, "MANA"); // betting on Even and High (>=19)

    masterContract.play(1, 0x641ad78baca220c5bd28b51ce8e0f495e85fe689, 1, 1, [1101], [0], [1000000000000000000], _localhash, "MANA") // playing slots
```


## Step 3 - play / make bets / spin (logic guide)
- to place bets and play you need to call only 1 method play() with following parameters

    --- _players: (address of the players) address array
    --- _landID: (ID of the land in game) integer
    --- _machineID: (ID of the machine in game) integer
    --- _betIDs: (array of bets IDs in the game) integer[]
    --- _betValues: (array of values for each betID if it is single bet / dozen / column, otherwise 0) integer[]
    --- _betAmount: (array of amount for each bet, how much willing to bet in tokens) integer[]
    --- _localhash: (generated by UI/Backend as random as possible)
    --- _tokenID: (ID of token that you want to play with)

- here is betID for slots game:

    --- 1101 - bets on jackpot will need to provide betValue

- here are 9 possible betIDs for roulette game:

    --- 3301 - betSingle (need to provide number in _betValues for the number on which user makes a bet 0-36)
    --- 3302 - betEven  (only requires bet amount, betting on all even numbers)
    --- 3303 - betOdd (only requires bet amount, betting on all odd numbers)
    --- 3304 - betRed (only requires bet amount, betting on red numbers)
    --- 3305 - betBlack (only requires bet amount, betting on black numbers)
    --- 3306 - betHigh (only requires bet amount, betting on 19-36 numbers)
    --- 3307 - betLow (only requires bet amount, betting on 1-18 numbers)
    --- 3308 - betColumn (need to provide number of the column 1-3)
    --- 3309 - betDozen (need to provide number of the dozen 1-3)

## Examples

play:
_gameID: 0
_players: ["0x641AD78BAca220C5BD28b51Ce8e0F495e85Fe689","0xa803c226c8281550454523191375695928DcFE92","0x641AD78BAca220C5BD28b51Ce8e0F495e85Fe689"]
_landID: 1
_machineID: 1
_betIDs: [3302,3303,3301]
_betValues: [0,0,15]
_betAmount: [100,100,100]
_localhash: 0x3e2fc3cfcd038924a024f6742c5e16642a8ac9e4ed85fea6619d388ac29a8616
_tokenName: MANA



```javascript
    RouleteParent.play(_userAddress, _landID, _machineID, _betIDs[], _betValues[], _betAmount[], _localhash);
    RouleteParent.play(address, uint256, uint256, uint256[], uint256[], uint256[], uint256);
    RouleteParent.play(0x641ad78baca220c5bd28b51ce8e0f495e85fe689, 1, 1, [3302], [0], [1000000000000000], [1]); //betting on Even
    RouleteParent.play(0x641ad78baca220c5bd28b51ce8e0f495e85fe689, 1, 1, [3302, 3306], [0,0], [1000000000000000, 1000000000000000], [1,1]); //betting on Even and High (>=19)

    SlotGame.play(0x641ad78baca220c5bd28b51ce8e0f495e85fe689, 1, 1, [1101], [0], [1000000000000000000],

```


## For testing:

npm install -g truffle@latest
npm install -g ethereumjs-testrpc@latest
npm install -g ganache-cli@latest

start ganachi

npm run test-master


## For deployment:

truffle migrate --network matic
truffle migrate --network mumbai


## For verification:

truffle-flattener TreasuryBackgammon.sol > TreasuryBackgammonFlat.sol  (flat the file for verification)



# Introduction

---

### DgPointer

This contract stores and assigns points to players and affilates.
Constructor parameters:
- _distributionToken - token address (points is charged to players in this token);
- _oldPointerAddress - old dgPointer contract address for tracking existing affiliates;
- name - contract name;
- version - contract version.

### dgPoker

This contract implements poker game.
Constructor parameters:
- _treasuryAddress - dgTreasure contract address;
- _pointerAddress - dgPointer contract address;
- _maxPlayers - maximum number of players who can play in one game;
- _houseFee - percentage of winnings sent to treasury;
- _tokenCount - number of available tokens in treasury.


# Deployment

---

### Deploy with [Remix - Ethereum IDE](https://remix.ethereum.org/) and [Metamask](https://metamask.io/)
1. Load contract and dependencies to IDE or use [remixd](https://remix-ide.readthedocs.io/en/latest/remixd.html)
2. [Compile contract](https://remix-ide.readthedocs.io/en/latest/compile.html) ("Solidity compiler" tab), if necessary choose compiler version.
3. Choose network in Metamask.
4. [Open "Deploy & run transactions" tab](https://remix-ide.readthedocs.io/en/latest/run.html) and choose "injected Web3".
5. Press "Deploy" button and approve operation in Metamask.

### Deploy with truffle migrations

Migration files locate in ***./migrations*** folder. For running migration enter command ***truffle migrate --network <network>***.

# Testing

---

Before test running enter console command in project directory - ***npm run chain***
For testing use commands:
- **npm run test-pointer** - for dgPointer;
- **npm run test-poker** - for dgPoker.


# Usage

---

### dgPoker

**Before starting the game, players must approve the required number of tokens to the treasury contract.**

**For the start game, use ***initializeGame*** function. Description for input parameters are described in smart-contract code.**

**For the end game, use ***manualPayout*** function. Description for input parameters are described in smart-contract code.**

Important parameters:

- _gameBeneficiary, _beneficiaryPercent - for each game, you can specify the beneficiary and percentage of houseFee which beneficiary will receive from the winnings;
- _wageredAmounts - array that contains of sums of the bets for each player (includes entry bets);
- _refundAmounts - array that contains the number of tokens to refund to players (difference between approval and wageredAmount).



